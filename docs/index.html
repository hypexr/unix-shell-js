<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unix Shell JS - Live Demo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Unix Shell JS - Live Demo</h1>
        <p class="description">Browser-based Unix/Linux command emulator with vi editor support</p>

        <div class="terminal" id="terminal">
            <div class="terminal-output">Unix Shell JS v1.0.0
Type 'help' to see available commands, 'ls' to list files, or 'vim README.md' to edit a file.
</div>
            <div class="terminal-line">
                <span class="prompt">user@demo:~$</span>
                <input type="text" class="terminal-input" id="input" autocomplete="off" autofocus>
            </div>
        </div>

        <div class="info">
            <h2>Try These Commands:</h2>
            <ul>
                <li>ls -la (list all files)</li>
                <li>cat README.md (read a file)</li>
                <li>mkdir mydir (create directory)</li>
                <li>cd mydir (change directory)</li>
                <li>touch file.txt (create file)</li>
                <li>vim notes.txt (edit with vi)</li>
                <li>tree (show directory tree)</li>
                <li>ps (show processes)</li>
            </ul>
        </div>

        <div class="links">
            <a href="https://github.com/hypexr/unix-shell-js">GitHub Repository</a>
            <a href="https://www.npmjs.com/package/unix-shell-js">npm Package</a>
        </div>
    </div>

    <script src="index.js"></script>
    <script src="vi-editor.js"></script>
    <script src="example-files.js"></script>
    <script>
        // Wait for scripts to load
        window.addEventListener('load', function() {
        // Initialize the shell
        const shell = new UnixShell({
            username: 'user',
            fileSystem: createExampleFiles('user'),
            persistence: {
                enabled: true,
                prefix: 'demo'
            }
        });

        const terminal = document.getElementById('terminal');
        const input = document.getElementById('input');

        function addOutput(text) {
            const output = document.createElement('div');
            output.className = 'terminal-output';
            output.textContent = text;
            terminal.insertBefore(output, terminal.lastElementChild);
        }

        function updatePrompt() {
            // Get the prompt in the last terminal-line (the active input line)
            // Specifically avoid history lines
            const activeLine = terminal.querySelector('.terminal-line:last-child');
            if (!activeLine || activeLine.classList.contains('terminal-history')) return;

            const prompt = activeLine.querySelector('.prompt');
            if (!prompt) return;

            const user = shell.getCurrentUser();
            let path = shell.getCurrentPath();
            const home = shell.environment.HOME;

            // Replace home with ~
            if (path === home) {
                path = '~';
            } else if (path.startsWith(home + '/')) {
                path = '~' + path.substring(home.length);
            }

            prompt.textContent = `${user}@demo:${path}$`;
        }

        // Update prompt on load to reflect any restored state from localStorage
        updatePrompt();

        input.addEventListener('keydown', (e) => {
            // Handle Tab for autocomplete
            if (e.key === 'Tab') {
                e.preventDefault();

                const partial = input.value.trim();
                if (!partial) return;

                const completions = shell.getCompletions(partial);

                if (completions.matches.length === 1) {
                    // Single match - auto complete
                    const match = completions.matches[0];

                    if (completions.type === 'command') {
                        input.value = match;
                    } else if (completions.type === 'path') {
                        // Replace the path part
                        const parts = partial.split(/\s+/);
                        const pathPrefix = completions.prefix;

                        if (pathPrefix.includes('/')) {
                            const lastSlash = pathPrefix.lastIndexOf('/');
                            const dirPart = pathPrefix.substring(0, lastSlash + 1);
                            parts[parts.length - 1] = dirPart + match;
                        } else {
                            parts[parts.length - 1] = match;
                        }

                        input.value = parts.join(' ');
                    }
                } else if (completions.matches.length > 1) {
                    // Multiple matches - show them
                    const matchList = completions.matches.join('  ');
                    addOutput(matchList);
                }
                return;
            }

            if (e.key === 'Enter') {
                const command = input.value.trim();

                if (command) {
                    // Capture current prompt text before executing command
                    const currentPromptText = terminal.querySelector('.terminal-line:last-child .prompt').textContent;

                    // Show command with the prompt as it was when command was entered
                    const commandLine = document.createElement('div');
                    commandLine.className = 'terminal-line terminal-history';
                    commandLine.innerHTML = `<span class="prompt">${currentPromptText}</span> ${command}`;
                    terminal.insertBefore(commandLine, terminal.lastElementChild);

                    // Execute command
                    const output = shell.execute(command);

                    // Handle special outputs
                    if (output === '__CLEAR__') {
                        // Clear terminal
                        const outputs = terminal.querySelectorAll('.terminal-output, .terminal-line:not(:last-child)');
                        outputs.forEach(el => el.remove());
                    } else if (output === '__VI_OPENED__') {
                        // Vi editor opened
                    } else if (output && output.startsWith('__USER_SWITCHED__:')) {
                        // User switched
                        updatePrompt();
                    } else if (output) {
                        // Show output
                        addOutput(output);
                    }

                    // Update prompt in case path changed
                    updatePrompt();
                }

                input.value = '';

                // Scroll terminal to bottom to keep input visible
                terminal.scrollTop = terminal.scrollHeight;
            }
        });

        // Focus input when clicking anywhere
        document.addEventListener('click', () => {
            input.focus();
        });
        }); // End of window.addEventListener('load')
    </script>
</body>
</html>
